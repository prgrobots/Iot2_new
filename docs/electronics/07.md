# Session 07: Environmental Sensors

**Week:** 7  
**Element:** ICTIOT503 Element 4: Test connectivity and compatibility | ICTIOT502 Element 2: Program IoT device  
**Duration:** 3.5 hours  
**Phase:** Electronics for Programmers

---

> **Note:** All electronics sessions can be completed using either Arduino (C++) or MicroPython on the ESP32. You may choose your preferred language for all programming tasks, code submissions, and portfolio checkpoints.

---

## Session Introduction

This week you'll build the **Haul Road Environmental Monitor** on the truck's roof panel. Rain sensors, photoresistors (light detection), and ultrasonic distance sensors will monitor road conditions. This completes **Assessment 5**, focusing on multi-sensor network testing and compatibility verification critical for fleet-wide deployment.

## Learning Objectives

By the end of this session, you will be able to:

- Interface rain detection sensors
- Read photoresistor values for ambient light monitoring
- Implement ultrasonic distance measurement (HC-SR04)
- Generate audible tones with piezo buzzers
- Complete **Assessment 5** with connectivity testing documentation

---

## Session Structure

1. **Environmental Monitoring Requirements** – Road safety context
2. **Rain & Light Sensors** – Analog input review
3. **Ultrasonic Distance** – Collision avoidance
4. **Piezo Tones** – Audio alerts
5. **Assessment 5 Submission** – Roof panel system

---

## Pre-Session Preparation

!!! info "Required Reading"
    - PhysComp → [Ultrasonic Sensors](https://makeabilitylab.github.io/physcomp/arduino/ultrasonic-distance-sensors.html)
    - PhysComp → [Piezo Buzzers](https://makeabilitylab.github.io/physcomp/arduino/buzzers.html)
    - HC-SR04 datasheet and timing diagrams

!!! tip "Setup Check"
    - [ ] Real ESP32 with environmental sensors from kit
    - [ ] 3D print roof panel enclosure
    - [ ] Test environment setup (water dropper for rain sensor, flashlight for photoresistor)

---

## RockCore Mining Context

Haul roads in open-pit mines face extreme conditions: dust storms reduce visibility, rain creates slippery surfaces, and poor lighting increases collision risk. Your **roof panel monitoring system** must:

- Detect rain and trigger wiper/speed reduction alerts
- Monitor ambient light for automatic headlight control
- Measure distance to obstacles for collision warning
- Provide audio alerts to operators

This is **Assessment 5** – testing multi-sensor compatibility under simulated interference (dust, vibration).

---

## Hands-On Tasks

### Task 1: Rain Sensor & Photoresistor

**Wiring:**
- Rain sensor analog out → GPIO 34
- Photoresistor → GPIO 35 (with 10kΩ pull-down)

```cpp
// Week 7 Task 1 - Rain & Light Detection
const int RAIN_PIN = 34;
const int LIGHT_PIN = 35;

void setup() {
  Serial.begin(115200);
  pinMode(RAIN_PIN, INPUT);
  pinMode(LIGHT_PIN, INPUT);
}

void loop() {
  int rainValue = analogRead(RAIN_PIN);
  int lightValue = analogRead(LIGHT_PIN);
  
  Serial.print("Rain: ");
  Serial.print(rainValue);
  Serial.print(" | Light: ");
  Serial.println(lightValue);
  
  // Rain detection (lower value = more water)
  if (rainValue < 2000) {
    Serial.println("ALERT: Rain detected - reduce speed");
  }
  
  // Low light detection
  if (lightValue < 500) {
    Serial.println("ALERT: Low visibility - activate headlights");
  }
  
  delay(1000);
}
```

### Task 2: HC-SR04 Ultrasonic Distance Sensor

**Wiring:**
- Trig → GPIO 12
- Echo → GPIO 14
- VCC → 5V
- GND → GND

```cpp
// Week 7 Task 2 - Ultrasonic Distance Measurement
const int TRIG_PIN = 12;
const int ECHO_PIN = 14;

void setup() {
  Serial.begin(115200);
  pinMode(TRIG_PIN, OUTPUT);
  pinMode(ECHO_PIN, INPUT);
}

float getDistance() {
  // Send 10us pulse
  digitalWrite(TRIG_PIN, LOW);
  delayMicroseconds(2);
  digitalWrite(TRIG_PIN, HIGH);
  delayMicroseconds(10);
  digitalWrite(TRIG_PIN, LOW);
  
  // Measure echo time
  long duration = pulseIn(ECHO_PIN, HIGH, 30000);  // 30ms timeout
  
  // Calculate distance (cm)
  float distance = duration * 0.034 / 2;
  return distance;
}

void loop() {
  float dist = getDistance();
  
  Serial.print("Distance: ");
  Serial.print(dist);
  Serial.println(" cm");
  
  if (dist < 50 && dist > 0) {
    Serial.println("WARNING: Obstacle within 50cm!");
  }
  
  delay(500);
}
```

### Task 3: Piezo Buzzer Audio Alerts

**Wiring:**
- Buzzer → GPIO 26
- GND → GND

```cpp
// Week 7 Task 3 - Piezo Tone Generation
const int BUZZER_PIN = 26;

void setup() {
  pinMode(BUZZER_PIN, OUTPUT);
  Serial.begin(115200);
}

void playWarning() {
  tone(BUZZER_PIN, 1000, 200);  // 1kHz for 200ms
  delay(300);
  tone(BUZZER_PIN, 1500, 200);
  delay(300);
}

void playCritical() {
  for (int i = 0; i < 5; i++) {
    tone(BUZZER_PIN, 2000, 100);
    delay(150);
  }
}

void loop() {
  // Test tones
  Serial.println("Warning tone...");
  playWarning();
  delay(2000);
  
  Serial.println("Critical alert tone...");
  playCritical();
  delay(3000);
}
```

### Task 4: Integrated Roof Panel System (Assessment 5)

```cpp
// Week 7 Task 4 - Complete Environmental Monitor
const int RAIN_PIN = 34;
const int LIGHT_PIN = 35;
const int TRIG_PIN = 12;
const int ECHO_PIN = 14;
const int BUZZER_PIN = 26;
const int STATUS_LED = 25;

void setup() {
  Serial.begin(115200);
  pinMode(RAIN_PIN, INPUT);
  pinMode(LIGHT_PIN, INPUT);
  pinMode(TRIG_PIN, OUTPUT);
  pinMode(ECHO_PIN, INPUT);
  pinMode(BUZZER_PIN, OUTPUT);
  pinMode(STATUS_LED, OUTPUT);
  
  Serial.println("=== RockCore Haul Road Monitor Active ===");
}

float getDistance() {
  digitalWrite(TRIG_PIN, LOW);
  delayMicroseconds(2);
  digitalWrite(TRIG_PIN, HIGH);
  delayMicroseconds(10);
  digitalWrite(TRIG_PIN, LOW);
  
  long duration = pulseIn(ECHO_PIN, HIGH, 30000);
  return duration * 0.034 / 2;
}

void loop() {
  int rainValue = analogRead(RAIN_PIN);
  int lightValue = analogRead(LIGHT_PIN);
  float distance = getDistance();
  
  // Data logging
  Serial.printf("Rain: %d | Light: %d | Distance: %.1f cm\n", 
                rainValue, lightValue, distance);
  
  bool alertActive = false;
  
  // Rain check
  if (rainValue < 2000) {
    Serial.println("ALERT: Rain detected");
    alertActive = true;
  }
  
  // Low light check
  if (lightValue < 500) {
    Serial.println("ALERT: Low visibility");
    alertActive = true;
  }
  
  // Collision warning
  if (distance < 50 && distance > 0) {
    Serial.println("CRITICAL: Obstacle detected!");
    tone(BUZZER_PIN, 2000, 500);
    digitalWrite(STATUS_LED, HIGH);
    delay(100);
    digitalWrite(STATUS_LED, LOW);
    alertActive = true;
  }
  
  if (alertActive) {
    tone(BUZZER_PIN, 1000, 200);
  }
  
  delay(1000);
}
```

---

## Check Your Knowledge

!!! question "Q1 – Sensor Interference"
    How might dust in a mining environment interfere with the ultrasonic sensor?
    ??? tip "Answer"
        Dust particles scatter ultrasonic waves, causing false readings or reduced range. Industrial deployments use protective housings and filtering algorithms to ignore spurious readings.

!!! question "Q2 – Rain Sensor Limitations"
    Why is the rain sensor less reliable than temperature sensors?
    ??? tip "Answer"
        Rain sensors detect resistance change with water contact. Dust, corrosion, and mineral deposits can cause false positives. Requires regular cleaning in mining environments.

!!! question "Q3 – Multiple I²C vs Analog Sensors"
    This session uses analog sensors (rain, light). What's one advantage over I²C sensors?
    ??? tip "Answer"
        Analog sensors are simpler and cheaper, requiring no communication protocol. Good for basic threshold detection. I²C sensors provide calibrated values and multi-parameter data.

---

## Assessment 5 Submission (Due End of Week 7)

**Submit to GitHub + Blackboard:**

1. **Connectivity test report** (2-3 pages):
   - Test scenarios: normal conditions, simulated dust interference, vibration testing
   - Compatibility verification: ESP32 GPIO limits, power consumption, I²C bus capacity
   - Failure modes identified and mitigation strategies

2. **Code:** Complete roof panel environmental monitor with comments

3. **Test video** (3-4 minutes):
   - Demonstrate rain detection (water drops)
   - Low light triggering (cover photoresistor)
   - Ultrasonic collision warning (hand approaching sensor)
   - Audio alert tones at different severities

4. **Wiring documentation:** Fritzing diagram showing all sensors on ESP32 GPIO map

5. **Fleet scalability analysis:** How would you deploy 20 of these systems? What components would fail first?

**Mapping:** ICTIOT503 Element 4 – Test connectivity and compatibility, ensure compatibility with ESP32 GPIO and I²C protocols.

---

**Navigation:** [← Week 6](06.md) | [Course Overview](../overview.md) | [Week 8 →](08.md)
