# Session 03: Advanced Output & Buttons

**Week:** 3  
**Element:** ICTIOT502 Element 2: Program IoT device  
**Duration:** 3.5 hours  
**Phase:** Electronics for Programmers

---

> **Note:** All electronics sessions can be completed using either Arduino (C++) or MicroPython on the ESP32. You may choose your preferred language for all programming tasks, code submissions, and portfolio checkpoints.

---

## Session Introduction

This week marks your transition to ESP32 and real buttons. You'll implement PWM crossfades for smooth RGB transitions and add manual override buttons for your truck's front panel. This is where simulation meets reality – you'll test button debouncing and learn why clean digital inputs matter in industrial environments where vibration can cause false triggers.

## Learning Objectives

By the end of this session, you will be able to:

- Transition from Arduino Uno to ESP32 in Wokwi
- Implement button inputs with proper pull-up/pull-down resistors
- Debug and fix button debouncing issues
- Create smooth RGB color crossfades using PWM
- Start **Assessment 1** (Engine Compartment Monitor)

---

## Session Structure

1. **ESP32 Setup** – Wokwi ESP32 project creation
2. **Button Input** – Digital input with debouncing
3. **RGB Crossfade** – Smooth color transitions
4. **Front Panel Assembly** – Physical build begins
5. **Assessment 1 Launch** – Engine compartment requirements

---

## Pre-Session Preparation

!!! info "Required Reading"
    - PhysComp → [Buttons](https://makeabilitylab.github.io/physcomp/arduino/buttons.html)
    - PhysComp → [Debouncing](https://makeabilitylab.github.io/physcomp/arduino/debouncing.html)
    - Review ESP32 pinout diagram (provided in resources)

!!! tip "Setup Check"
    - [ ] Wokwi account ready
    - [ ] Create new ESP32 project in Wokwi
    - [ ] 3D print front panel chassis (start printing this week)

---

## RockCore Mining Context

Pit station operators need to manually override truck status when performing maintenance. Today you'll add two buttons:

- **Green Button**: Force operational status
- **Red Button**: Emergency stop signal

Vibration from mining operations can cause "bouncing" – multiple false triggers from a single button press. You'll implement software debouncing to prevent false alarms.

---

## Hands-On Tasks

### Task 1: Basic Button Input (ESP32)

**Wokwi:** Create ESP32 project, add button with 10kΩ pull-down resistor to GPIO 4.

```cpp
// Week 3 Task 1 - Button Input
const int BUTTON_PIN = 4;
const int LED_PIN = 2;  // ESP32 onboard LED

void setup() {
  pinMode(BUTTON_PIN, INPUT);  // External pull-down resistor
  pinMode(LED_PIN, OUTPUT);
  Serial.begin(115200);
}

void loop() {
  int buttonState = digitalRead(BUTTON_PIN);
  
  if (buttonState == HIGH) {
    digitalWrite(LED_PIN, HIGH);
    Serial.println("Button PRESSED");
  } else {
    digitalWrite(LED_PIN, LOW);
    Serial.println("Button RELEASED");
  }
  delay(100);
}
```

### Task 2: Debounced Button

```cpp
// Week 3 Task 2 - Debounced Button
const int BUTTON_PIN = 4;
int lastButtonState = LOW;
unsigned long lastDebounceTime = 0;
unsigned long debounceDelay = 50;  // 50ms debounce

void setup() {
  pinMode(BUTTON_PIN, INPUT);
  Serial.begin(115200);
}

void loop() {
  int reading = digitalRead(BUTTON_PIN);
  
  if (reading != lastButtonState) {
    lastDebounceTime = millis();
  }
  
  if ((millis() - lastDebounceTime) > debounceDelay) {
    if (reading == HIGH) {
      Serial.println("STABLE button press detected");
    }
  }
  
  lastButtonState = reading;
}
```

### Task 3: RGB Crossfade with Button Control

```cpp
// Week 3 Task 3 - RGB Crossfade with Button Override
const int RED_PIN = 25;
const int GREEN_PIN = 26;
const int BLUE_PIN = 27;
const int OVERRIDE_BTN = 4;

int targetR = 0, targetG = 255, targetB = 0;  // Start green
int currentR = 0, currentG = 0, currentB = 0;

void setup() {
  pinMode(RED_PIN, OUTPUT);
  pinMode(GREEN_PIN, OUTPUT);
  pinMode(BLUE_PIN, OUTPUT);
  pinMode(OVERRIDE_BTN, INPUT);
}

void crossfade() {
  if (currentR < targetR) currentR++;
  if (currentR > targetR) currentR--;
  if (currentG < targetG) currentG++;
  if (currentG > targetG) currentG--;
  if (currentB < targetB) currentB++;
  if (currentB > targetB) currentB--;
  
  analogWrite(RED_PIN, currentR);
  analogWrite(GREEN_PIN, currentG);
  analogWrite(BLUE_PIN, currentB);
}

void loop() {
  if (digitalRead(OVERRIDE_BTN) == HIGH) {
    // Red fault state
    targetR = 255; targetG = 0; targetB = 0;
  } else {
    // Green operational state
    targetR = 0; targetG = 255; targetB = 0;
  }
  
  crossfade();
  delay(10);
}
```

---

## Check Your Knowledge

!!! question "Q1 – Pull-down Resistors"
    Why do we need a 10kΩ resistor on the button input?
    ??? tip "Answer"
        Without it, the GPIO pin "floats" when the button is not pressed, reading random values. The pull-down resistor ensures a stable LOW when the button is released.

!!! question "Q2 – Debouncing"
    What causes button "bouncing" in industrial environments like mining?
    ??? tip "Answer"
        Mechanical contacts bounce due to vibration, creating multiple HIGH/LOW transitions in milliseconds. Software debouncing ignores these rapid transitions.

!!! question "Q3 – ESP32 vs Arduino Uno"
    What is one advantage of ESP32 for this truck project?
    ??? tip "Answer"
        ESP32 has built-in WiFi/Bluetooth for AWS IoT connectivity (used in Weeks 10-14), more GPIO pins, and faster processing.

---

## Assessment 1 Launch: Engine Compartment Monitor

**Due:** Week 4

**Requirements:**
- DHT11 (temperature/humidity sensor)
- MQ-2 (gas sensor)
- Flame sensor
- Threshold-based alerting code

**Mapping:** ICTIOT502 Element 2 – Program IoT device, test and rectify faults like sensor calibration errors.

**Task this week:** Start designing your circuit diagram. Next week you'll implement it in Wokwi and real hardware.

---

## Portfolio Checkpoint

**Save to GitHub:**

1. Wokwi link for debounced button + RGB crossfade
2. Screenshot showing serial monitor with clean debounced presses (no false triggers)
3. Photo of your 3D printed front panel chassis (if ready)

---

**Navigation:** [← Week 2](02.md) | [Course Overview](../overview.md) | [Week 4 →](04.md)
