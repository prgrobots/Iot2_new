# Session 06: RFID, RTC & Touch

**Week:** 6  
**Element:** ICTIOT502 Element 1: Identify business requirements | ICTIOT502 Element 2: Program IoT device  
**Duration:** 3.5 hours  
**Phase:** Electronics for Programmers

---

> **Note:** All electronics sessions can be completed using either Arduino (C++) or MicroPython on the ESP32. You may choose your preferred language for all programming tasks, code submissions, and portfolio checkpoints.

---

## Session Introduction

This week you'll build the **Operator Cabin Safety System** using RFID authentication, real-time clock (RTC) for access logging, and capacitive touch sensors. This completes **Assessment 2**, focusing on secure access control for authorized mining personnel – a critical safety requirement at RockCore.

## Learning Objectives

By the end of this session, you will be able to:

- Interface RFID-RC522 module for card authentication
- Configure DS3231 RTC module for accurate timestamping
- Implement capacitive touch sensing on ESP32
- Design secure access control logic
- Complete **Assessment 2** with requirements documentation

---

## Session Structure

1. **Access Control Requirements** – Mining safety regulations
2. **RFID Authentication** – Card reading and validation
3. **RTC Integration** – Access logging with timestamps
4. **Touch Sensors** – Backup manual override
5. **Assessment 2 Submission** – Left panel cabin system

---

## Pre-Session Preparation

!!! info "Required Reading"
    - PhysComp → [ESP32 Touch Sensors](https://makeabilitylab.github.io/physcomp/esp32/capacitive-touch.html)
    - PhysComp → [ESP32 Lesson 6-7](https://makeabilitylab.github.io/physcomp/esp32/)
    - RFID-RC522 library documentation
    - DS3231 RTC datasheet overview

!!! tip "Setup Check"
    - [ ] Install libraries: `MFRC522`, `RTClib` by Adafruit
    - [ ] RFID cards/tags from kit (minimum 2 for testing)
    - [ ] 3D print left panel cabin enclosure

---

## RockCore Mining Context

**Business Requirement:** Only authorized operators can start the haul truck. All access attempts must be logged with timestamps for compliance audits.

**Your cabin system must:**

- Read RFID cards and validate against authorized list
- Log every access attempt (success/failure) with timestamp
- Provide touch sensor backup for emergency access
- Integrate with engine compartment monitor (Assessment 1)

---

## Hands-On Tasks

### Task 1: RFID-RC522 Card Reading

**Wiring (SPI protocol):**
- SDA → GPIO 5
- SCK → GPIO 18
- MOSI → GPIO 23
- MISO → GPIO 19
- RST → GPIO 27
- 3.3V and GND

```cpp
// Week 6 Task 1 - RFID Card Reader
#include <SPI.h>
#include <MFRC522.h>

#define SS_PIN 5
#define RST_PIN 27

MFRC522 rfid(SS_PIN, RST_PIN);

void setup() {
  Serial.begin(115200);
  SPI.begin();
  rfid.PCD_Init();
  Serial.println("RockCore Access Control: Ready");
  Serial.println("Scan RFID card...");
}

void loop() {
  if (!rfid.PICC_IsNewCardPresent() || !rfid.PICC_ReadCardSerial()) {
    return;
  }
  
  // Read card UID
  Serial.print("Card UID: ");
  String cardID = "";
  for (byte i = 0; i < rfid.uid.size; i++) {
    cardID += String(rfid.uid.uidByte[i], HEX);
  }
  Serial.println(cardID);
  
  rfid.PICC_HaltA();
  delay(1000);
}
```

### Task 2: RTC Module for Access Logging

**Wiring (I²C):** Shares SDA/SCL with OLED.

```cpp
// Week 6 Task 2 - RTC Timestamping
#include <Wire.h>
#include <RTClib.h>

RTC_DS3231 rtc;

void setup() {
  Serial.begin(115200);
  
  if (!rtc.begin()) {
    Serial.println("RTC not found!");
    while(1);
  }
  
  // Set time once (comment out after first run)
  // rtc.adjust(DateTime(F(__DATE__), F(__TIME__)));
  
  Serial.println("RTC initialized");
}

void loop() {
  DateTime now = rtc.now();
  
  Serial.print("Current time: ");
  Serial.print(now.year());
  Serial.print('/');
  Serial.print(now.month());
  Serial.print('/');
  Serial.print(now.day());
  Serial.print(" ");
  Serial.print(now.hour());
  Serial.print(':');
  Serial.print(now.minute());
  Serial.print(':');
  Serial.println(now.second());
  
  delay(5000);
}
```

### Task 3: ESP32 Capacitive Touch Sensor

```cpp
// Week 6 Task 3 - Touch Sensor Override
const int TOUCH_PIN = T0;  // GPIO 4
const int THRESHOLD = 40;  // Adjust based on testing

void setup() {
  Serial.begin(115200);
}

void loop() {
  int touchValue = touchRead(TOUCH_PIN);
  
  Serial.print("Touch value: ");
  Serial.println(touchValue);
  
  if (touchValue < THRESHOLD) {
    Serial.println("TOUCH DETECTED - Emergency override");
  }
  
  delay(500);
}
```

### Task 4: Complete Cabin Access System (Assessment 2)

```cpp
// Week 6 Task 4 - Integrated Cabin Safety System
#include <SPI.h>
#include <MFRC522.h>
#include <RTClib.h>

#define SS_PIN 5
#define RST_PIN 27
#define GREEN_LED 26
#define RED_LED 25
#define TOUCH_PIN T0

MFRC522 rfid(SS_PIN, RST_PIN);
RTC_DS3231 rtc;

// Authorized card UIDs (add your cards here)
String authorizedCards[] = {"a3b2c1d0", "12345678"};
const int numAuthorized = 2;

void setup() {
  Serial.begin(115200);
  SPI.begin();
  rfid.PCD_Init();
  rtc.begin();
  
  pinMode(GREEN_LED, OUTPUT);
  pinMode(RED_LED, OUTPUT);
  
  Serial.println("=== RockCore Cabin Access System ===");
}

void logAccess(String cardID, bool authorized) {
  DateTime now = rtc.now();
  
  Serial.print("[");
  Serial.print(now.timestamp());
  Serial.print("] ");
  
  if (authorized) {
    Serial.print("ACCESS GRANTED - Card: ");
  } else {
    Serial.print("ACCESS DENIED - Card: ");
  }
  Serial.println(cardID);
}

bool isAuthorized(String cardID) {
  for (int i = 0; i < numAuthorized; i++) {
    if (cardID == authorizedCards[i]) {
      return true;
    }
  }
  return false;
}

void loop() {
  // Check for RFID card
  if (rfid.PICC_IsNewCardPresent() && rfid.PICC_ReadCardSerial()) {
    String cardID = "";
    for (byte i = 0; i < rfid.uid.size; i++) {
      cardID += String(rfid.uid.uidByte[i], HEX);
    }
    
    bool authorized = isAuthorized(cardID);
    logAccess(cardID, authorized);
    
    if (authorized) {
      digitalWrite(GREEN_LED, HIGH);
      digitalWrite(RED_LED, LOW);
      Serial.println("Truck enabled - ready to start");
    } else {
      digitalWrite(GREEN_LED, LOW);
      digitalWrite(RED_LED, HIGH);
      Serial.println("Unauthorized access attempt - security alert");
    }
    
    rfid.PICC_HaltA();
    delay(3000);
    digitalWrite(GREEN_LED, LOW);
    digitalWrite(RED_LED, LOW);
  }
  
  // Check for emergency touch override
  if (touchRead(TOUCH_PIN) < 40) {
    Serial.println("EMERGENCY OVERRIDE ACTIVATED");
    logAccess("TOUCH-OVERRIDE", true);
    digitalWrite(GREEN_LED, HIGH);
    delay(5000);
    digitalWrite(GREEN_LED, LOW);
  }
  
  delay(100);
}
```

---

## Check Your Knowledge

!!! question "Q1 – RFID vs Keypad"
    Why is RFID better than a keypad for mining equipment access?
    ??? tip "Answer"
        RFID is faster (no typing), works with gloves, can't be shared easily (physical card required), and provides unique ID for audit trails.

!!! question "Q2 – RTC Importance"
    Why not use ESP32's internal clock for timestamps?
    ??? tip "Answer"
        ESP32 loses time on power cycle and has clock drift. DS3231 has battery backup and high accuracy (<2 ppm) required for legal compliance logs.

!!! question "Q3 – Touch Sensor Use Case"
    When would an operator use the touch override instead of RFID?
    ??? tip "Answer"
        Emergency situations where RFID reader fails, or during maintenance when rapid repeated access is needed.

---

## Assessment 2 Submission (Due End of Week 6)

**Submit to GitHub + Blackboard:**

1. **Requirements document** (1-2 pages):
   - Mining safety regulations requiring access control
   - Hardware selection justification (why RFID-RC522, why DS3231)
   - Compliance mapping (ICTIOT502 Element 1)

2. **Code:** Complete cabin access system with comments

3. **Access log export:** CSV or text file showing 10+ access attempts (mix of authorized/unauthorized)

4. **Test video** (2-3 minutes):
   - Authorized card → green LED, system enabled
   - Unauthorized card → red LED, denied
   - Touch override activation
   - RTC timestamp verification

5. **Integration plan:** How cabin system connects to engine monitor (Assessment 1) for full safety interlock

**Mapping:** ICTIOT502 Element 1 – Identify business requirements, select hardware aligned to compliance.

---

**Navigation:** [← Week 5](05.md) | [Course Overview](../overview.md) | [Week 7 →](07.md)
