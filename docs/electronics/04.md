# Session 04: Analog Sensors

**Week:** 4  
**Element:** ICTIOT502 Element 2: Program IoT device  
**Duration:** 3.5 hours  
**Phase:** Electronics for Programmers

---

> **Note:** All electronics sessions can be completed using either Arduino (C++) or MicroPython on the ESP32. You may choose your preferred language for all programming tasks, code submissions, and portfolio checkpoints.

---

## Session Introduction

This week you transition from Wokwi simulation to **real ESP32 hardware** for the first time. You'll build the Engine Compartment Monitor using DHT11 (temperature/humidity), MQ-2 (gas), and flame sensors. This session completes **Assessment 1**, where you'll implement threshold-based alerting and test sensor calibration – critical skills for predictive maintenance at RockCore Mining.

## Learning Objectives

By the end of this session, you will be able to:

- Interface DHT11 temperature/humidity sensor with ESP32
- Read analog values from MQ-2 gas sensor
- Implement digital flame detection
- Set and test threshold-based alerts
- Complete **Assessment 1** with fault rectification documentation

---

## Session Structure

1. **Sensor Theory Review** – Analog vs digital sensors
2. **Wokwi Simulation** – Test DHT11 + MQ-2 code
3. **Real ESP32 Build** – Physical wiring and testing
4. **Threshold Alerts** – Implement warning/fault logic
5. **Assessment 1 Submission** – Portfolio evidence

---

## Pre-Session Preparation

!!! info "Required Reading"
    - PhysComp → [Analog Input](https://makeabilitylab.github.io/physcomp/arduino/analog-input.html)
    - DHT11 datasheet (see Resources page)
    - MQ-2 sensor calibration guide

!!! tip "Setup Check"
    - [ ] Keyestudio ESP32 kit collected (from instructor)
    - [ ] Wokwi project ready for pre-testing
    - [ ] Install DHT library in Arduino IDE: `DHT sensor library by Adafruit`

---

## RockCore Mining Context

Engine compartment fires are a leading cause of heavy equipment loss in mining. Your **Engine Compartment Monitor** must detect:

- **Temperature > 60°C**: Warning (amber LED)
- **Temperature > 80°C**: Fault (red LED + buzzer)
- **Gas detected (MQ-2 > 300)**: Potential fuel leak
- **Flame detected**: Immediate shutdown signal

Today you'll build this system and test it with simulated faults (e.g., holding a lighter near sensors).

---

## Hands-On Tasks

### Task 1: DHT11 Temperature & Humidity (Wokwi)

**Wokwi:** Add DHT22 sensor (DHT11 not available in Wokwi, but code is identical).

```cpp
// Week 4 Task 1 - DHT11 Temperature Sensor
#include <DHT.h>

#define DHTPIN 4
#define DHTTYPE DHT11
DHT dht(DHTPIN, DHTTYPE);

void setup() {
  Serial.begin(115200);
  dht.begin();
  Serial.println("RockCore Engine Monitor: Starting...");
}

void loop() {
  float temp = dht.readTemperature();
  float humidity = dht.readHumidity();
  
  if (isnan(temp) || isnan(humidity)) {
    Serial.println("ERROR: DHT sensor read failed");
    return;
  }
  
  Serial.print("Temp: ");
  Serial.print(temp);
  Serial.print("°C | Humidity: ");
  Serial.print(humidity);
  Serial.println("%");
  
  delay(2000);
}
```

### Task 2: MQ-2 Gas Sensor (Analog Read)

**Wokwi:** Add potentiometer to simulate MQ-2 (or use real MQ-2 on ESP32).

```cpp
// Week 4 Task 2 - MQ-2 Gas Detection
const int MQ2_PIN = 34;  // ESP32 ADC pin

void setup() {
  Serial.begin(115200);
  pinMode(MQ2_PIN, INPUT);
}

void loop() {
  int gasLevel = analogRead(MQ2_PIN);
  
  Serial.print("Gas Level: ");
  Serial.print(gasLevel);
  
  if (gasLevel > 300) {
    Serial.println(" - WARNING: Gas detected!");
  } else {
    Serial.println(" - Normal");
  }
  
  delay(1000);
}
```

### Task 3: Integrated Engine Monitor with Alerts (Real ESP32)

**Wiring:**
- DHT11: GPIO 4
- MQ-2: GPIO 34
- Flame sensor: GPIO 35
- Red LED: GPIO 25 (+ 220Ω resistor)
- Buzzer: GPIO 26

```cpp
// Week 4 Task 3 - Complete Engine Compartment Monitor (Assessment 1)
#include <DHT.h>

#define DHTPIN 4
#define MQ2_PIN 34
#define FLAME_PIN 35
#define RED_LED 25
#define BUZZER 26

#define TEMP_WARNING 60
#define TEMP_FAULT 80
#define GAS_THRESHOLD 300

DHT dht(DHTPIN, DHT11);

void setup() {
  Serial.begin(115200);
  dht.begin();
  pinMode(MQ2_PIN, INPUT);
  pinMode(FLAME_PIN, INPUT);
  pinMode(RED_LED, OUTPUT);
  pinMode(BUZZER, OUTPUT);
  
  Serial.println("=== RockCore Engine Monitor Active ===");
}

void loop() {
  float temp = dht.readTemperature();
  int gasLevel = analogRead(MQ2_PIN);
  int flameDetected = digitalRead(FLAME_PIN);
  
  // Check for sensor faults
  if (isnan(temp)) {
    Serial.println("FAULT: DHT11 sensor failure - check wiring");
    return;
  }
  
  // Temperature thresholds
  if (temp > TEMP_FAULT) {
    digitalWrite(RED_LED, HIGH);
    tone(BUZZER, 1000);
    Serial.println("CRITICAL: Temperature fault - shutdown required");
  } else if (temp > TEMP_WARNING) {
    digitalWrite(RED_LED, HIGH);
    noTone(BUZZER);
    Serial.println("WARNING: High temperature detected");
  } else {
    digitalWrite(RED_LED, LOW);
    noTone(BUZZER);
  }
  
  // Gas detection
  if (gasLevel > GAS_THRESHOLD) {
    Serial.println("WARNING: Gas leak detected");
  }
  
  // Flame detection
  if (flameDetected == LOW) {  // Most flame sensors are active-LOW
    digitalWrite(RED_LED, HIGH);
    tone(BUZZER, 2000);
    Serial.println("CRITICAL: FLAME DETECTED - EMERGENCY STOP");
  }
  
  // Data logging
  Serial.printf("Temp: %.1f°C | Gas: %d | Flame: %s\n", 
                temp, gasLevel, flameDetected ? "No" : "YES");
  
  delay(2000);
}
```

---

## Check Your Knowledge

!!! question "Q1 – Sensor Calibration"
    Why might your MQ-2 sensor give different readings than your classmate's with the same gas source?
    ??? tip "Answer"
        MQ-2 sensors require warm-up time (24-48 hours for stable baseline) and may have manufacturing variance. Calibration using known gas concentrations is essential for accurate readings.

!!! question "Q2 – Analog vs Digital"
    Why is the flame sensor digital (HIGH/LOW) while MQ-2 is analog (0-4095)?
    ??? tip "Answer"
        Flame sensors use a comparator circuit with preset threshold (flame/no flame). MQ-2 provides continuous resistance change proportional to gas concentration, read as analog voltage.

!!! question "Q3 – Fault Rectification"
    If your DHT11 returns `nan` (not a number), what are three possible causes?
    ??? tip "Answer"
        1) Incorrect wiring (VCC/GND swapped), 2) Wrong GPIO pin in code, 3) Faulty sensor or poor connections on breadboard.

---

## Assessment 1 Submission (Due End of Week 4)

**Submit to GitHub + Blackboard:**

1. **Code:** Complete `engine_monitor.ino` with comments
2. **Wiring diagram:** Fritzing or hand-drawn schematic
3. **Test video** (2-3 minutes): Show normal operation, then trigger each fault:
   - Heat DHT11 with hair dryer (temp warning/fault)
   - Simulate gas leak
   - Trigger flame sensor
4. **Fault rectification log:** Document at least one bug/issue you fixed (e.g., sensor calibration, wiring error, threshold tuning)
5. **Reflection paragraph:** How does this monitor prevent equipment loss at RockCore?

**Mapping:** ICTIOT502 Element 2 – Program IoT device, test and rectify faults.

---

**Navigation:** [← Week 3](03.md) | [Course Overview](../overview.md) | [Week 5 →](05.md)
