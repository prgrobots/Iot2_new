# Session 10: AWS IoT Core & Secure Connection

**Week:** 10  
**Element:** ICTIOT503 Element 1: Scope design options  
**Duration:** 3.5 hours  
**Phase:** AWS IoT Integration

---

## Session Introduction

Welcome to the AWS phase! This week you'll register your haul truck as an AWS IoT Thing, establish secure MQTT connectivity, and publish real sensor data to the cloud. You'll complete two AWS Skill Builder courses (1.5 hours total) and extend them with your real ESP32 hardware.

## Learning Objectives

By the end of this session, you will be able to:

- Create and configure AWS IoT Things
- Generate and install X.509 certificates on ESP32
- Publish MQTT messages from ESP32 to AWS IoT Core
- Subscribe to topics and view real-time data in AWS console
- Implement secure TLS connectivity

---

## Session Structure

1. **AWS Skill Builder** – Foundations + Secure Connection courses (1.5 h)
2. **IoT Thing Registration** – Create truck in AWS console
3. **Certificate Installation** – Secure authentication setup
4. **MQTT Publishing** – Real sensor data to cloud
5. **Portfolio Checkpoint** – First cloud connection evidence

---

## Pre-Session Preparation

!!! info "Required Completion"
    - AWS Skill Builder account active
    - AWS student sandbox credit ($100) activated
    - Complete: [Getting Started with AWS IoT](https://explore.skillbuilder.aws/) (35 min)
    - Complete: [Securely Connecting AWS IoT Devices](https://explore.skillbuilder.aws/) (45 min)

!!! tip "Setup Check"
    - [ ] ESP32 truck fully functional from Week 9
    - [ ] Arduino IDE with `PubSubClient` library installed
    - [ ] AWS IAM credentials configured

---

## RockCore Mining Context

Your haul truck currently operates standalone. To enable **fleet-wide monitoring**, RockCore needs:

- Real-time telemetry from all 20 trucks
- Centralized dashboard for pit supervisors
- Historical data storage for maintenance planning
- Automated alerts when faults occur

AWS IoT Core provides the scalable infrastructure for fleet connectivity.

---

## AWS Skill Builder Courses (Complete First)

### Course 1: Getting Started with AWS IoT (35 min)
**Topics:**
- AWS IoT Core overview
- Thing registry concepts
- MQTT protocol basics
- Security model

### Course 2: Securely Connecting AWS IoT Devices (45 min)
**Topics:**
- X.509 certificate authentication
- TLS encryption
- IoT policies
- Connection troubleshooting

**Deliverable:** Screenshot of both course completion certificates.

---

## Hands-On Tasks

### Task 1: Create IoT Thing in AWS Console

1. Open AWS IoT Core console
2. Navigate to **Manage → Things**
3. Create Thing: `rockcore-truck-HC01`
4. Download certificates:
   - Device certificate (`.pem.crt`)
   - Private key (`.pem.key`)
   - Root CA certificate (Amazon Root CA 1)

5. Create IoT Policy named `RockCoreTruckPolicy`:
```json
{
  "Version": "2012-10-17",
  "Statement": [
    {
      "Effect": "Allow",
      "Action": "iot:Connect",
      "Resource": "arn:aws:iot:REGION:ACCOUNT:client/rockcore-truck-*"
    },
    {
      "Effect": "Allow",
      "Action": "iot:Publish",
      "Resource": "arn:aws:iot:REGION:ACCOUNT:topic/rockcore/trucks/HC01/*"
    },
    {
      "Effect": "Allow",
      "Action": "iot:Subscribe",
      "Resource": "arn:aws:iot:REGION:ACCOUNT:topicfilter/rockcore/trucks/HC01/*"
    },
    {
      "Effect": "Allow",
      "Action": "iot:Receive",
      "Resource": "arn:aws:iot:REGION:ACCOUNT:topic/rockcore/trucks/HC01/*"
    }
  ]
}
```

6. Attach policy to certificate
7. Attach certificate to Thing

### Task 2: Install Certificates on ESP32

Convert certificates to C++ header format:

```cpp
// secrets.h - DO NOT commit to public GitHub!
const char AWS_CERT_CA[] = R"EOF(
-----BEGIN CERTIFICATE-----
[Your Amazon Root CA 1 content]
-----END CERTIFICATE-----
)EOF";

const char AWS_CERT_CRT[] = R"EOF(
-----BEGIN CERTIFICATE-----
[Your device certificate content]
-----END CERTIFICATE-----
)EOF";

const char AWS_CERT_PRIVATE[] = R"EOF(
-----BEGIN RSA PRIVATE KEY-----
[Your private key content]
-----END RSA PRIVATE KEY-----
)EOF";

#define AWS_IOT_ENDPOINT "xxxxx.iot.us-east-1.amazonaws.com"
#define THINGNAME "rockcore-truck-HC01"
```

### Task 3: MQTT Publishing from ESP32

```cpp
// Week 10 Task 3 - AWS IoT MQTT Publishing
#include <WiFi.h>
#include <WiFiClientSecure.h>
#include <PubSubClient.h>
#include <DHT.h>
#include "secrets.h"

const char* ssid = "YOUR_WIFI_SSID";
const char* password = "YOUR_WIFI_PASSWORD";

#define DHTPIN 4
DHT dht(DHTPIN, DHT11);

WiFiClientSecure net;
PubSubClient client(net);

void connectWiFi() {
  Serial.print("Connecting to WiFi");
  WiFi.begin(ssid, password);
  
  while (WiFi.status() != WL_CONNECTED) {
    delay(500);
    Serial.print(".");
  }
  Serial.println(" Connected!");
}

void connectAWS() {
  net.setCACert(AWS_CERT_CA);
  net.setCertificate(AWS_CERT_CRT);
  net.setPrivateKey(AWS_CERT_PRIVATE);
  
  client.setServer(AWS_IOT_ENDPOINT, 8883);
  
  Serial.print("Connecting to AWS IoT");
  while (!client.connect(THINGNAME)) {
    Serial.print(".");
    delay(1000);
  }
  Serial.println(" Connected to AWS IoT!");
}

void publishTelemetry() {
  float temp = dht.readTemperature();
  int gas = analogRead(34);
  
  char payload[200];
  snprintf(payload, sizeof(payload), 
           "{\"truck\":\"HC01\",\"temp\":%.1f,\"gas\":%d,\"timestamp\":%lu}",
           temp, gas, millis());
  
  client.publish("rockcore/trucks/HC01/telemetry", payload);
  Serial.print("Published: ");
  Serial.println(payload);
}

void setup() {
  Serial.begin(115200);
  dht.begin();
  
  connectWiFi();
  connectAWS();
  
  Serial.println("=== RockCore Truck HC-01 AWS Connected ===");
}

void loop() {
  if (!client.connected()) {
    connectAWS();
  }
  client.loop();
  
  publishTelemetry();
  delay(5000);  // Publish every 5 seconds
}
```

### Task 4: Test MQTT in AWS Console

1. Open **AWS IoT Core → Test → MQTT test client**
2. Subscribe to topic: `rockcore/trucks/HC01/#`
3. Verify messages appearing in real-time
4. Screenshot showing telemetry data

---

## Check Your Knowledge

!!! question "Q1 – MQTT vs HTTP"
    Why use MQTT instead of HTTP for IoT devices?
    ??? tip "Answer"
        MQTT is lightweight (smaller packets), maintains persistent connection (no reconnection overhead), supports publish/subscribe (one-to-many), and works better on unreliable networks.

!!! question "Q2 – Certificate Security"
    Why are X.509 certificates more secure than username/password?
    ??? tip "Answer"
        Certificates use public-key cryptography (can't be brute-forced), are device-specific (can't be shared), support mutual TLS authentication, and can be revoked individually without affecting other devices.

!!! question "Q3 – Topic Hierarchy"
    Why use `rockcore/trucks/HC01/telemetry` instead of just `data`?
    ??? tip "Answer"
        Hierarchical topics enable fleet organization (subscribe to `rockcore/trucks/#` for all trucks), per-truck policies, regional filtering, and data type separation (telemetry vs alerts).

---

## Portfolio Checkpoint

**Submit to GitHub:**

1. AWS Skill Builder completion screenshots (2 courses)
2. Screenshot of Thing registry showing `rockcore-truck-HC01`
3. Screenshot of MQTT test client receiving telemetry
4. **Code:** Complete AWS MQTT publishing sketch (without private keys!)
5. **Reflection paragraph:** How does cloud connectivity enable fleet-scale predictive maintenance that standalone trucks cannot?

**Note:** Create `.gitignore` to exclude `secrets.h` from version control!

---

**Navigation:** [← Week 9 (Electronics)](../electronics/09.md) | [Course Overview](../overview.md) | [Week 11 →](11.md)
