# Session 13: Edge Processing & Industrial Protocols

**Week:** 13  
**Element:** ICTIOT503 Element 1: Scope design options for edge processing  
**Duration:** 3.5 hours  
**Phase:** AWS IoT Integration

---

## Session Introduction

This week focuses on **edge computing** with AWS Greengrass for local data processing. You'll complete the SimuLearn lab on ETL at the edge and deploy the AWS IoT Greengrass Components lab – both critical for mining operations with intermittent connectivity.

## Learning Objectives

By the end of this session, you will be able to:

- Deploy AWS IoT Greengrass Core on laptop/Raspberry Pi
- Implement edge-based anomaly detection (local processing)
- Process data locally before cloud transmission
- Reduce bandwidth and improve latency

---

## Session Structure

1. **SimuLearn Lab** – ETL at the Edge (1 h)
2. **AWS Lab** – Deploying IoT Greengrass Components (1 h)
3. **Greengrass Core Setup** – Edge device configuration
4. **Local Anomaly Detection** – Process vibration data at edge
5. **Edge-to-Cloud Architecture** – Hybrid deployment

---

## Pre-Session Preparation

!!! info "Required Completion"
    - SimuLearn: "ETL at the Edge"
    - Lab: "Deploying AWS IoT Greengrass Components" (AWS Skill Builder)
    - Laptop or Raspberry Pi for Greengrass Core (ESP32 not powerful enough)

!!! tip "Setup Check"
    - [ ] AWS Greengrass Core software installed
    - [ ] Python 3.8+ for Lambda functions
    - [ ] Truck ESP32 functional from previous weeks

---

## RockCore Mining Context

**Problem:** Underground pit zones have no cellular/WiFi coverage. Trucks collect data for 2-hour shifts, but:
- Can't wait 2 hours to detect engine failures
- Bandwidth limited when trucks surface (20 trucks × 5KB/sec = 100KB/sec)
- Critical alerts must trigger immediately

**Solution:** AWS Greengrass Core on truck's onboard computer (simulated with laptop) processes data locally:
- Vibration anomaly detection runs at edge
- Only anomalies + summary stats sent to cloud
- Reduces bandwidth by 90%

---

## SimuLearn Lab & AWS Lab (Complete First)

### Lab 1: ETL at the Edge (SimuLearn)
**Focus:**
- Extract sensor data
- Transform/aggregate locally
- Load to cloud only when necessary

### Lab 2: Deploying AWS IoT Greengrass Components (AWS Skill Builder)
**Focus:**
- Greengrass Core concepts
- Component deployment
- Local processing

**Deliverable:** Screenshots of both lab completions.

---

## Hands-On Tasks

### Task 1: Install Greengrass Core (Laptop)

**AWS Console → IoT Core → Greengrass → Core devices:**

1. Create Core device: `rockcore-edge-gateway`
2. Download Greengrass Core software
3. Install on laptop:
```bash
sudo ./GreengrassInstaller -r <region> -t <thing-name> -c <cert-path>
```

4. Verify deployment:
```bash
sudo systemctl status greengrass
```

### Task 2: Deploy Lambda Function for Local Anomaly Detection

**Lambda function (Python) runs on Greengrass Core:**

```python
# anomaly_detector.py - Runs locally on edge device
import json
import greengrasssdk

client = greengrasssdk.client('iot-data')

THRESHOLD = 2.2
anomaly_count = 0

def lambda_handler(event, context):
    global anomaly_count
    
    # Receives vibration data from ESP32 via local MQTT
    vibration = event.get('vibration', 0)
    truck_id = event.get('truck', 'unknown')
    
    # Local processing - no cloud needed
    if vibration > THRESHOLD:
        anomaly_count += 1
        
        # Only send anomalies to cloud
        alert = {
            'truck': truck_id,
            'vibration': vibration,
            'anomaly_count': anomaly_count,
            'severity': 'CRITICAL' if vibration > 3.0 else 'WARNING'
        }
        
        # Publish to cloud (when connected)
        client.publish(
            topic=f'rockcore/alerts/{truck_id}',
            payload=json.dumps(alert)
        )
        
        print(f"Anomaly detected: {vibration}g - Alert sent to cloud")
    
    # Always return to local ESP32 for immediate feedback
    return {
        'statusCode': 200,
        'body': json.dumps({
            'status': 'ALERT' if vibration > THRESHOLD else 'NORMAL',
            'anomaly_count': anomaly_count
        })
    }
```

**Deploy to Greengrass:**
```bash
aws greengrass create-function-definition \
  --name rockcore-anomaly-detector \
  --initial-version file://function-config.json
```

### Task 3: ESP32 to Greengrass Local MQTT

**ESP32 publishes to local Greengrass Core instead of AWS Cloud:**

```cpp
// Week 13 Task 3 - Local MQTT to Greengrass
#include <WiFi.h>
#include <PubSubClient.h>

// Greengrass Core local endpoint
const char* mqtt_server = "192.168.1.100";  // Laptop IP
const int mqtt_port = 8883;  // Greengrass local MQTT

WiFiClient espClient;
PubSubClient client(espClient);

void publishToEdge(float vibration) {
  char payload[100];
  snprintf(payload, sizeof(payload),
    "{\"truck\":\"HC01\",\"vibration\":%.2f}",
    vibration);
  
  // Publish to local Greengrass Core
  client.publish("greengrass/rockcore/HC01/vibration", payload);
  Serial.println("Data sent to edge gateway");
}

void subscribeToEdgeResponse() {
  // Greengrass Lambda responds with local decision
  client.subscribe("greengrass/rockcore/HC01/response");
}

void callback(char* topic, byte* payload, unsigned int length) {
  // Immediate response from edge (no cloud latency)
  Serial.print("Edge response received in ");
  Serial.print(millis());
  Serial.println("ms");
  
  // Parse response and trigger local alert if needed
}

void setup() {
  client.setServer(mqtt_server, mqtt_port);
  client.setCallback(callback);
  subscribeToEdgeResponse();
}
```

### Task 4: Modbus Simulation (Industrial Protocol)

**Simulate Modbus sensor using Python (laptop):**

```python
# modbus_simulator.py - Simulates industrial sensor
from pymodbus.server.sync import StartTcpServer
from pymodbus.datastore import ModbusSlaveContext, ModbusServerContext
import random

def update_sensor_data(context):
    # Simulate temperature sensor on Modbus register 0
    temp = random.randint(50, 90)
    context[0].setValues(3, 0, [temp])
    
    # Simulate vibration on register 1
    vibe = random.randint(10, 30)  # 1.0g to 3.0g (×10)
    context[0].setValues(3, 1, [vibe])

# Start Modbus TCP server on port 502
StartTcpServer(context, address=("0.0.0.0", 502))
```

**Greengrass function reads Modbus and publishes MQTT:**

```python
# modbus_to_mqtt.py - Protocol gateway
from pymodbus.client.sync import ModbusTcpClient
import greengrasssdk

client_mqtt = greengrasssdk.client('iot-data')
client_modbus = ModbusTcpClient('localhost', port=502)

def lambda_handler(event, context):
    # Read Modbus registers
    result = client_modbus.read_holding_registers(0, 2)
    
    temp = result.registers[0]
    vibe = result.registers[1] / 10.0  # Convert back to g
    
    # Convert to MQTT/JSON
    payload = {
        'temperature': temp,
        'vibration': vibe,
        'protocol': 'modbus'
    }
    
    client_mqtt.publish(
        topic='rockcore/industrial/HC01',
        payload=json.dumps(payload)
    )
    
    return {'statusCode': 200}
```

---

## Check Your Knowledge

!!! question "Q1 – Edge vs Cloud Processing"
    When should you process data at the edge instead of sending everything to the cloud?
    ??? tip "Answer"
        Edge processing when: 1) Low latency required (safety systems), 2) Limited bandwidth, 3) Intermittent connectivity, 4) Privacy concerns, 5) High data volume with low value (send summaries only).

!!! question "Q2 – Greengrass Offline"
    If Greengrass loses internet, can it still run Lambda functions?
    ??? tip "Answer"
        Yes! Greengrass Core runs Lambda functions locally. Devices can communicate via local MQTT broker. When connectivity returns, Greengrass syncs logs and queued cloud messages.

!!! question "Q3 – Protocol Conversion"
    Why can't ESP32 directly speak Modbus to industrial sensors?
    ??? tip "Answer"
        Modbus requires RS-485 hardware interface (not on ESP32) or TCP stack complexity. Gateway pattern separates concerns: ESP32 handles sensors, Greengrass handles legacy industrial protocols.

---

## Portfolio Checkpoint

**Submit to GitHub:**

1. SimuLearn completion screenshots (3 labs)
2. **Greengrass deployment** screenshot showing Core device online
3. **Lambda function logs** from Greengrass showing local anomaly detection
4. **Architecture diagram** showing ESP32 → Greengrass Core → AWS Cloud flow
5. **Test video** (4-5 minutes):
   - ESP32 publishing to local Greengrass
   - Lambda function detecting anomaly locally
   - Immediate response to ESP32 (< 100ms latency)
   - Cloud alert appearing in AWS console
   - Demonstrate offline operation (disconnect laptop from internet)

---

**Navigation:** [← Week 12](12.md) | [Course Overview](../overview.md) | [Week 14 →](14.md)
