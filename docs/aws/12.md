# Session 12: Fleet Management & OTA Updates

**Week:** 12  
**Element:** ICTIOT503 Element 1: Scope design options for fleet architecture  
**Duration:** 3.5 hours  
**Phase:** AWS IoT Integration

---

## Session Introduction

This week you'll organize trucks into **Thing Groups** for fleet management and implement **Over-The-Air (OTA) firmware updates**. You'll complete the AWS Skill Builder course on managing IoT devices at scale (3.5 hours) and use OTA to remotely change your truck's vibration threshold without physical access.

## Learning Objectives

By the end of this session, you will be able to:

- Organize IoT Things into hierarchical groups
- Create and deploy OTA firmware updates
- Implement fleet-wide configuration management
- Use bulk device provisioning
- Monitor fleet health dashboards

---

## Session Structure

1. **AWS Skill Builder** – Managing Devices at Scale (3.5 h)
2. **Thing Groups** – Fleet organization
3. **OTA Update Setup** – Firmware deployment pipeline
4. **Remote Configuration** – Change vibration threshold
5. **Fleet Dashboard** – CloudWatch metrics

---

## Pre-Session Preparation

!!! info "Required Completion"
    - Complete: [Managing AWS IoT Devices at Scale](https://explore.skillbuilder.aws/) (3.5 hours)
    - Plus: SimuLearn "OTA Updates" lab
    - Truck fully functional with shadow integration from Week 11

!!! tip "Setup Check"
    - [ ] AWS CLI installed and configured
    - [ ] S3 bucket created for firmware storage
    - [ ] Code signing certificate (for production OTA)

---

## RockCore Mining Context

**Fleet Scale:** Rock Core operates 20 haul trucks across 3 pit zones:
- **Zone A**: Trucks HC-01 to HC-07 (active mining)
- **Zone B**: Trucks HC-08 to HC-14 (ore transport)
- **Zone C**: Trucks HC-15 to HC-20 (maintenance/standby)

**Challenge:** A vibration algorithm bug requires threshold change from 1.8g to 2.2g. Visiting 20 trucks physically = 40 hours labor. OTA update = 20 minutes.

---

## AWS Skill Builder Course (Complete First)

### Managing AWS IoT Devices at Scale (3.5 hours)
**Topics:**
- Thing Groups and dynamic groups
- Fleet indexing and search
- Jobs for device management
- OTA updates with code signing
- Bulk provisioning

**Plus SimuLearn:** "OTA Updates" lab

**Deliverable:** Screenshot of course completion + SimuLearn completion.

---

## Hands-On Tasks

### Task 1: Create Thing Groups for Fleet

**AWS Console → IoT Core → Manage → Thing Groups:**

Create hierarchy:
```
rockcore-fleet/
├── zone-a/
│   ├── HC-01 (your truck)
│   └── HC-02 to HC-07
├── zone-b/
│   └── HC-08 to HC-14
└── zone-c/
    └── HC-15 to HC-20
```

**Attach Attributes:**
```json
{
  "zone": "A",
  "firmware_version": "1.0.0",
  "vibration_threshold": "1.8"
}
```

### Task 2: Prepare OTA Firmware

**Modified firmware (version 1.1.0) with new threshold:**

```cpp
// firmware_v1_1_0.ino - Updated vibration threshold
const char* FIRMWARE_VERSION = "1.1.0";
float VIBRATION_THRESHOLD = 2.2;  // Changed from 1.8

// ... rest of Week 11 code ...

void setup() {
  Serial.begin(115200);
  Serial.print("Firmware version: ");
  Serial.println(FIRMWARE_VERSION);
  Serial.print("Vibration threshold: ");
  Serial.println(VIBRATION_THRESHOLD);
  
  // ... existing setup code ...
}
```

**Compile and upload firmware binary to S3:**
```bash
# Compile in Arduino IDE: Sketch → Export Compiled Binary
# Upload to S3
aws s3 cp firmware_v1_1_0.bin s3://rockcore-ota-firmware/
```

### Task 3: Create OTA Job

**AWS Console → IoT Core → Manage → Jobs:**

1. Create job: `update-vibration-threshold-v1-1`
2. Select targets: Thing Group `zone-a`
3. Job document:
```json
{
  "operation": "firmware_update",
  "files": [{
    "fileName": "firmware_v1_1_0.bin",
    "fileSource": {
      "streamId": "rockcore-firmware-stream",
      "fileId": 0
    },
    "fileSize": 894464
  }],
  "version": "1.1.0"
}
```

### Task 4: ESP32 OTA Handler (Simplified)

```cpp
// Week 12 Task 4 - OTA Update Handler
#include <Update.h>
#include <HTTPClient.h>

const char* firmwareURL = "https://rockcore-ota-firmware.s3.amazonaws.com/firmware_v1_1_0.bin";

void performOTAUpdate() {
  Serial.println("Starting OTA update...");
  
  HTTPClient http;
  http.begin(firmwareURL);
  
  int httpCode = http.GET();
  if (httpCode == 200) {
    int contentLength = http.getSize();
    bool canBegin = Update.begin(contentLength);
    
    if (canBegin) {
      WiFiClient* client = http.getStreamPtr();
      size_t written = Update.writeStream(*client);
      
      if (written == contentLength) {
        Serial.println("OTA update successful - rebooting...");
      }
      
      if (Update.end()) {
        if (Update.isFinished()) {
          ESP.restart();
        }
      }
    }
  }
  http.end();
}

// Subscribe to OTA job topic
void mqttCallback(char* topic, byte* payload, unsigned int length) {
  if (strcmp(topic, "$aws/things/rockcore-truck-HC01/jobs/notify") == 0) {
    Serial.println("OTA job received");
    performOTAUpdate();
  }
}

void setup() {
  // ... existing setup ...
  client.subscribe("$aws/things/rockcore-truck-HC01/jobs/notify");
}
```

### Task 5: Fleet Dashboard with CloudWatch

**Create CloudWatch Dashboard:**

Metrics to track:
- Fleet connectivity status (20 trucks online/offline)
- Average temperature across fleet
- Vibration anomaly count by zone
- OTA update success rate

**Custom metric publishing:**
```cpp
// Add to main loop()
void publishMetrics() {
  char payload[200];
  snprintf(payload, sizeof(payload),
    "{\"metric\":\"vibration_anomaly\",\"zone\":\"A\",\"truck\":\"HC01\",\"count\":%d}",
    anomalyCount);
  
  client.publish("rockcore/metrics/vibration", payload);
}
```

---

## Check Your Knowledge

!!! question "Q1 – Thing Groups Benefits"
    Why use Thing Groups instead of individual device management?
    ??? tip "Answer"
        Groups enable bulk operations (one OTA job → 7 trucks in zone-a), policy inheritance, organized billing/monitoring, and dynamic membership based on attributes.

!!! question "Q2 – OTA Rollback"
    If firmware 1.1.0 causes trucks to crash, how do you rollback?
    ??? tip "Answer"
        Deploy new OTA job with firmware 1.0.0 binary. For critical systems, implement "golden image" partition on ESP32 that boots safe firmware if main partition fails boot test.

!!! question "Q3 – Code Signing"
    Why is code signing required for production OTA?
    ??? tip "Answer"
        Prevents attackers from pushing malicious firmware. AWS IoT Jobs can verify signature before download, ensuring only authorized firmware runs on fleet.

---

## Portfolio Checkpoint

**Submit to GitHub:**

1. AWS Skill Builder + SimuLearn completion screenshots
2. **Thing Group hierarchy** screenshot from AWS console
3. **OTA Job status** screenshot showing successful deployment
4. **Before/After video** (2-3 minutes):
   - Show truck running firmware 1.0.0 (threshold 1.8)
   - Trigger OTA update from AWS console
   - Truck reboots with firmware 1.1.0 (threshold 2.2)
   - Demonstrate new threshold in action
5. **Fleet dashboard** screenshot showing metrics from multiple "trucks" (can simulate with serial output)

---

**Navigation:** [← Week 11](11.md) | [Course Overview](../overview.md) | [Week 13 →](13.md)
