# Session 11: Device Data, Rules & Shadows

**Week:** 11  
**Element:** ICTIOT503 Element 1: Scope design options  
**Duration:** 3.5 hours  
**Phase:** AWS IoT Integration

---

## Session Introduction

This week you'll implement **Device Shadows** for your truck's engine temperature and cabin lock state, plus create **IoT Rules** to route data to SNS for SMS alerts. You'll complete the AWS Skill Builder course on device data handling (2 hours) and apply it to real hardware scenarios.

## Learning Objectives

By the end of this session, you will be able to:

- Configure and update Device Shadows from ESP32
- Create IoT Rules for data routing and filtering
- Integrate SNS for SMS/email notifications
- Implement shadow synchronization for offline resilience
- Handle shadow state conflicts

---

## Session Structure

1. **AWS Skill Builder** – Handling Device Data & States (2 h)
2. **Device Shadow Setup** – Engine temp + cabin lock
3. **IoT Rules Engine** – Data routing to SNS
4. **Shadow Sync Testing** – Offline/online scenarios
5. **Alert System Demo** – Real SMS notifications

---

## Pre-Session Preparation

!!! info "Required Completion"
    - Complete: [Handling AWS IoT Device Data & States](https://explore.skillbuilder.aws/) (2 hours)
    - Week 10 truck already connected to AWS IoT Core
    - SNS topic created for alerts

!!! tip "Setup Check"
    - [ ] ESP32 truck publishing telemetry successfully
    - [ ] AWS IoT console access
    - [ ] Mobile phone for SMS testing

---

## RockCore Mining Context

**Business Problem:** Haul trucks often enter radio dead zones underground. When connectivity returns, the cloud must know:
- Current engine temperature (desired state)
- Whether cabin is locked (reported state)
- Any missed alerts during offline period

**Device Shadows** solve this by maintaining both desired and reported states, with automatic synchronization.

---

## AWS Skill Builder Course (Complete First)

### Handling AWS IoT Device Data & States (2 hours)
**Topics:**
- Device Shadow concepts (desired vs reported)
- Shadow documents (JSON structure)
- Delta updates and conflict resolution
- Rules Engine basics
- Time-series data handling

**Deliverable:** Screenshot of course completion certificate.

---

## Hands-On Tasks

### Task 1: Create Device Shadow for Engine Temperature

**AWS Console:**
1. Navigate to IoT Core → Manage → Things → rockcore-truck-HC01
2. Device Shadows tab → Create shadow (Classic shadow enabled)

**ESP32 Code:**
```cpp
// Week 11 Task 1 - Device Shadow Update
#include <WiFiClientSecure.h>
#include <PubSubClient.h>
#include <ArduinoJson.h>
#include <DHT.h>
#include "secrets.h"

#define DHTPIN 4
DHT dht(DHTPIN, DHT11);

WiFiClientSecure net;
PubSubClient client(net);

const char* shadowUpdateTopic = "$aws/things/rockcore-truck-HC01/shadow/update";
const char* shadowDeltaTopic = "$aws/things/rockcore-truck-HC01/shadow/update/delta";

void updateShadow(float temp, bool engineRunning) {
  StaticJsonDocument<200> doc;
  JsonObject state = doc.createNestedObject("state");
  JsonObject reported = state.createNestedObject("reported");
  
  reported["temperature"] = temp;
  reported["engine"] = engineRunning ? "running" : "stopped";
  reported["timestamp"] = millis();
  
  char jsonBuffer[256];
  serializeJson(doc, jsonBuffer);
  
  client.publish(shadowUpdateTopic, jsonBuffer);
  Serial.print("Shadow updated: ");
  Serial.println(jsonBuffer);
}

void handleShadowDelta(char* topic, byte* payload, unsigned int length) {
  Serial.println("Shadow delta received:");
  
  StaticJsonDocument<200> doc;
  deserializeJson(doc, payload, length);
  
  if (doc["state"].containsKey("desiredTemp")) {
    float desired = doc["state"]["desiredTemp"];
    Serial.print("Cloud wants temperature: ");
    Serial.println(desired);
    // Could trigger cooling system here
  }
}

void setup() {
  Serial.begin(115200);
  dht.begin();
  
  // Connect WiFi and AWS (code from Week 10)
  // ...
  
  client.setCallback(handleShadowDelta);
  client.subscribe(shadowDeltaTopic);
  
  Serial.println("Device Shadow active");
}

void loop() {
  float temp = dht.readTemperature();
  bool engineRunning = (temp > 30);  // Simple heuristic
  
  updateShadow(temp, engineRunning);
  
  client.loop();
  delay(10000);  // Update shadow every 10 seconds
}
```

### Task 2: IoT Rule for Temperature Alerts

**Create Rule in AWS Console:**

**Rule Name:** `RockCore_Temp_Alert_Rule`

**SQL Statement:**
```sql
SELECT 
  topic(4) as truckID,
  temp as temperature,
  timestamp() as alert_time
FROM 
  'rockcore/trucks/+/telemetry'
WHERE 
  temp > 70
```

**Action:** SNS → Select your alert topic

**Test:**
- Heat DHT11 above 70°C
- Check SMS/email received

### Task 3: Cabin Lock Shadow (RFID Integration)

```cpp
// Week 11 Task 3 - Cabin Lock Shadow
#include <MFRC522.h>

MFRC522 rfid(5, 27);
bool cabinLocked = true;

void updateLockShadow(bool locked, String lastCard) {
  StaticJsonDocument<200> doc;
  JsonObject state = doc.createNestedObject("state");
  JsonObject reported = state.createNestedObject("reported");
  
  reported["cabin_locked"] = locked;
  reported["last_access_card"] = lastCard;
  reported["access_time"] = millis();
  
  char jsonBuffer[256];
  serializeJson(doc, jsonBuffer);
  
  client.publish("$aws/things/rockcore-truck-HC01/shadow/update", jsonBuffer);
}

void checkRFID() {
  if (rfid.PICC_IsNewCardPresent() && rfid.PICC_ReadCardSerial()) {
    String cardID = "";
    for (byte i = 0; i < rfid.uid.size; i++) {
      cardID += String(rfid.uid.uidByte[i], HEX);
    }
    
    bool authorized = isAuthorized(cardID);
    
    if (authorized) {
      cabinLocked = false;
      updateLockShadow(false, cardID);
      Serial.println("Cabin unlocked - shadow updated");
    } else {
      // Send unauthorized access alert
      publishAlert("Unauthorized access attempt", cardID);
    }
    
    rfid.PICC_HaltA();
  }
}
```

### Task 4: Offline Resilience Testing

**Test Scenario:**

1. Disconnect ESP32 from WiFi
2. Change sensor values (heat DHT11)
3. Shadow shows last known state in AWS console
4. Reconnect WiFi
5. Shadow automatically syncs with latest reported state

```cpp
// Week 11 Task 4 - Shadow Sync After Reconnect
void reconnectWithShadow() {
  if (!client.connected()) {
    Serial.println("Reconnecting to AWS...");
    
    if (client.connect(THINGNAME)) {
      Serial.println("Reconnected - requesting shadow state");
      
      // Request current shadow
      client.publish("$aws/things/rockcore-truck-HC01/shadow/get", "");
      
      // Resubscribe to delta
      client.subscribe("$aws/things/rockcore-truck-HC01/shadow/update/delta");
      client.subscribe("$aws/things/rockcore-truck-HC01/shadow/get/accepted");
    }
  }
}

void loop() {
  if (!client.connected()) {
    reconnectWithShadow();
  }
  
  // ... rest of code
}
```

---

## Check Your Knowledge

!!! question "Q1 – Desired vs Reported"
    What's the difference between desired and reported state in a Device Shadow?
    ??? tip "Answer"
        **Desired**: What the cloud/operator wants the device to be (e.g., "lock cabin"). **Reported**: Actual current state from device (e.g., "cabin locked"). Delta = desired - reported.

!!! question "Q2 – IoT Rules Cost"
    Why use IoT Rules instead of processing data in a Lambda function?
    ??? tip "Answer"
        IoT Rules are cheaper (no compute time charges), lower latency (no function cold start), and simpler for basic filtering/routing. Use Lambda for complex processing only.

!!! question "Q3 – Shadow Sync Conflict"
    Truck reports temp=75°C, but shadow cached temp=60°C (from 10 min ago). What happens?
    ??? tip "Answer"
        AWS Shadow service timestamps each update. Latest timestamp wins. Truck's 75°C update overwrites cached 60°C. Always use device timestamps for conflict resolution.

---

## Portfolio Checkpoint

**Submit to GitHub:**

1. AWS Skill Builder completion screenshot
2. **Shadow document JSON** exported from AWS console showing temperature + lock state
3. **IoT Rule screenshot** showing SQL query and SNS action
4. **SMS/email alert screenshot** proving rule triggered
5. **Code:** Complete shadow update sketch with RFID integration
6. **Test video** (3-4 minutes):
   - Show shadow updating in AWS console as temperature changes
   - Trigger temp alert (SMS received)
   - Demonstrate offline → online shadow sync
   - RFID unlock updates shadow

---

**Navigation:** [← Week 10](10.md) | [Course Overview](../overview.md) | [Week 12 →](12.md)
